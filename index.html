<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏≠‡πÇ‡∏≠‡∏ó‡∏µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .scanner-input {
            font-family: 'Courier New', monospace;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-success {
            animation: pulseSuccess 0.5s ease-in-out;
        }
        @keyframes pulseSuccess {
            0% { background-color: rgb(34, 197, 94); }
            50% { background-color: rgb(22, 163, 74); }
            100% { background-color: rgb(34, 197, 94); }
        }
        .deployment-highlight {
            border: 2px solid #ef4444; /* Red border */
            background-color: #fee2e2; /* Red background light */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏≠‡πÇ‡∏≠‡∏ó‡∏µ</h1>
            <p class="text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="flex border-b">
                <button onclick="showTab('overview')" id="tab-overview" class="flex-1 py-4 px-6 text-center font-medium border-b-2 border-blue-500 text-blue-600 bg-blue-50">
                    üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                </button>
                <button onclick="showTab('receive')" id="tab-receive" class="flex-1 py-4 px-6 text-center font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    üì• ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤
                </button>
                <button onclick="showTab('issue')" id="tab-issue" class="flex-1 py-4 px-6 text-center font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢
                </button>
                <button onclick="showTab('settings')" id="tab-settings" class="flex-1 py-4 px-6 text-center font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                </button>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Google Apps Script URL</label>
                        <input type="url" id="sheets-url" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">API Key (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                        <input type="password" id="api-key" placeholder="‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á Google Sheets" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="auto-sync" class="mr-2">
                        <label for="auto-sync" class="text-sm text-gray-700">‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="testConnection()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
                        </button>
                        <button onclick="showDeleteConfirmModal()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>
                    
                    <!-- UPDATED DEPLOYMENT INSTRUCTIONS WITH HIGHLIGHT -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h3 class="font-medium text-yellow-800 mb-2">üìã ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script:</h3>
                        <ol class="text-sm text-yellow-700 space-y-1 list-decimal list-inside">
                            <li>‡∏™‡∏£‡πâ‡∏≤‡∏á Google Sheets ‡πÉ‡∏´‡∏°‡πà</li>
                            <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà Extensions ‚Üí Apps Script</li>
                            <li>‡∏ß‡∏≤‡∏á Code ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÉ‡∏ô Apps Script</li>
                            <li>**‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å:** Deploy ‡πÄ‡∏õ‡πá‡∏ô Web App ‡πÇ‡∏î‡∏¢‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ "Execute as: Me" ‡πÅ‡∏•‡∏∞ "Who has access: Anyone"</li>
                            <li>**‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å:** ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</li>
                        </ol>
                        <div class="mt-3 p-3 bg-gray-100 rounded text-xs overflow-x-auto">
                            <strong>Google Apps Script Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î):</strong><br>
                            <pre class="mt-2 text-xs"><code>// Global variable to store shared data
var SHARED_DATA_KEY = 'IOT_SHARED_DATA';

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    if (data.action === 'test') {
      return ContentService
        .createTextOutput(JSON.stringify({success: true, message: 'Connection OK'}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Save shared data for cross-device sync
    if (data.action === 'saveData') {
      const properties = PropertiesService.getScriptProperties();
      properties.setProperty(SHARED_DATA_KEY, JSON.stringify({
        data: data.data,
        timestamp: data.timestamp || Date.now()
      }));
      
      return ContentService
        .createTextOutput(JSON.stringify({success: true, message: 'Data saved to cloud'}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Update inventory in spreadsheet
    if (data.action === 'updateInventory' && data.data && data.data.length > 0) {
      const sheet = SpreadsheetApp.getActiveSheet();
      
      // Clear existing data
      sheet.clear();
      
      // Set headers
      const headers = Object.keys(data.data[0]);
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      
      // Set data
      const rows = data.data.map(item => headers.map(h => item[h] || ''));
      if (rows.length > 0) {
        sheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
      }
      
      return ContentService
        .createTextOutput(JSON.stringify({success: true, rows: rows.length}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({success: false, error: 'Invalid action'}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    const action = e.parameter.action;
    
    // Get shared data for cross-device sync
    if (action === 'getData') {
      const properties = PropertiesService.getScriptProperties();
      const sharedDataStr = properties.getProperty(SHARED_DATA_KEY);
      
      if (sharedDataStr) {
        const sharedData = JSON.parse(sharedDataStr);
        return ContentService
          .createTextOutput(JSON.stringify({
            success: true,
            data: sharedData.data,
            timestamp: sharedData.timestamp
          }))
          .setMimeType(ContentService.MimeType.JSON);
      } else {
        return ContentService
          .createTextOutput(JSON.stringify({
            success: true,
            data: { inventory: [], settings: {} },
            timestamp: 0
          }))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({success: true, message: 'IoT Inventory API Ready'}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</code></pre>
                        </div>
                        <div class="deployment-highlight">
                            <h3 class="font-bold text-red-600 mb-2 text-lg">üö® ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£ Deploy ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ö‡πà‡∏≠‡∏¢:</h3>
                            <p class="text-sm text-red-700 space-y-1">
                                1. ‡∏ß‡∏≤‡∏á Code ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí Save<br>
                                2. ‡∏Ñ‡∏•‡∏¥‡∏Å **Deploy** ‚Üí **New deployment** (‡∏´‡∏£‡∏∑‡∏≠ Manage deployment ‚Üí Edit)<br>
                                3. Type: **Web app**<br>
                                4. Execute as: **Me** (‡∏ï‡∏±‡∏ß‡∏â‡∏±‡∏ô)<br>
                                5. Who has access: **Anyone** (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)<br>
                                6. **Deploy** ‚Üí **‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL** (Deployment ID) ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
                            </p>
                            <p class="text-xs text-red-500 mt-2">**‡∏´‡∏≤‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠ 2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ URL ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö**</p>
                            <p class="text-xs text-red-500 mt-2">**‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏£‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (http://127.0.0.1) ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î CORS error ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ù‡∏±‡πà‡∏á Client ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Simple Request ‡πÅ‡∏•‡πâ‡∏ß ‡∏ã‡∏∂‡πà‡∏á‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö**</p>
                        </div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
                        <h3 class="font-medium text-blue-800 mb-2">üíæ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå</h3>
                        <div class="text-sm text-blue-700 space-y-1">
                            <p>‚úÖ <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏ß‡∏£:</strong> ‡πÉ‡∏ä‡πâ IndexedDB ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á - ‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢‡πÅ‡∏°‡πâ‡∏õ‡∏¥‡∏î‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</p>
                            <p>üîÑ <strong>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á:</strong> ‡∏°‡∏µ localStorage ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Å‡∏£‡∏ì‡∏µ IndexedDB ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
                            <p>üåê <strong>‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå:</strong> ‡πÉ‡∏ä‡πâ BroadcastChannel - ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</p>
                            <p>‚ö° <strong>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ:</strong> ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ó‡πá‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠)</p>
                            <p id="sync-status" class="font-medium">üîÑ <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...</p>
                        </div>
                        <div class="mt-3 flex items-center">
                            <input type="checkbox" id="cloud-sync-toggle" checked class="mr-2">
                            <label for="cloud-sync-toggle" class="text-sm text-blue-700">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p class="text-3xl font-bold" id="total-items">0</p>
                        </div>
                        <div class="text-4xl">üì¶</div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</p>
                            <p class="text-3xl font-bold" id="stock-items">0</p>
                        </div>
                        <div class="text-4xl">‚úÖ</div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-orange-100">‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                            <p class="text-3xl font-bold" id="issued-items">0</p>
                        </div>
                        <div class="text-4xl">üì§</div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                    <div class="flex gap-2">
                        <button onclick="exportToGoogleSheets()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            üìä ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheets
                        </button>
                        <button onclick="showDeleteConfirmModal()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">SN</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            </tr>
                        </thead>
                        <tbody id="items-table" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <!-- Pagination Controls: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ -->
                <div class="flex justify-center items-center mt-6 space-x-2" id="pagination-controls">
                    <button onclick="changePage(-1)" id="prev-page-btn" class="px-4 py-2 border rounded-lg text-gray-700 bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        < ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                    </button>
                    <span id="page-info" class="text-sm font-medium text-gray-600">‡∏´‡∏ô‡πâ‡∏≤ 1 ‡∏à‡∏≤‡∏Å 1</span>
                    <button onclick="changePage(1)" id="next-page-btn" class="px-4 py-2 border rounded-lg text-gray-700 bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ >
                    </button>
                </div>
            </div>
        </div>

        <!-- Receive Tab -->
        <div id="receive-tab" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üì• ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</h2>
                <form onsubmit="receiveItem(event)" class="space-y-4">
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">üîç ‡πÅ‡∏™‡∏Å‡∏ô/‡πÉ‡∏™‡πà Serial Number (‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß)</label>
                            <textarea id="receive-sn" placeholder="‡πÅ‡∏™‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå SN (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠ SN ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß)&#10;‡πÄ‡∏ä‡πà‡∏ô:&#10;SN001&#10;SN002&#10;SN003" rows="4"
                                   class="scanner-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"></textarea>
                            <p class="text-sm text-gray-500 mt-1">üí° ‡πÉ‡∏™‡πà Serial Number ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">üì± ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                            <select id="receive-product" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                                <option value="‡∏Å‡∏•‡πâ‡∏≠‡∏á CCTV">‡∏Å‡∏•‡πâ‡∏≠‡∏á CCTV</option>
                                <option value="SIM">SIM</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-medium transition-colors">
                        ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤
                    </button>
                </form>
            </div>
        </div>

        <!-- Issue Tab -->
        <div id="issue-tab" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                <form onsubmit="issueItem(event)" class="space-y-4">
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">üîç ‡πÅ‡∏™‡∏Å‡∏ô/‡πÉ‡∏™‡πà Serial Number (‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß)</label>
                            <textarea id="issue-sn" placeholder="‡πÅ‡∏™‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå SN (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠ SN ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß)&#10;‡πÄ‡∏ä‡πà‡∏ô:&#10;SN001&#10;SN002&#10;SN003" rows="4"
                                   class="scanner-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-lg"></textarea>
                            <p class="text-sm text-gray-500 mt-1">üí° ‡πÉ‡∏™‡πà Serial Number ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">üë®‚Äçüîß ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á</label>
                            <input type="text" id="issue-technician" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 px-6 rounded-lg font-medium transition-colors">
                        üì§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢
                    </button>
                </form>
            </div>
        </div>



        <!-- Success/Error Messages -->
        <div id="message-container" class="fixed top-4 right-4 z-50"></div>
        
        <!-- Delete Confirmation Modal -->
        <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="text-xl font-bold text-red-600 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <p class="text-gray-600">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">üîê ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label>
                    <!-- UPDATED PLACEHOLDER FOR CLARITY -->
                    <input type="password" id="delete-password" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô John19195" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-center text-lg">
                    <p class="text-xs text-gray-500 mt-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="hideDeleteConfirmModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button onclick="confirmDeleteAllData()" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                        üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage - ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        let inventory = [];
        let settings = {};
        let db;
        let cloudSyncEnabled = true;
        let lastSyncTime = 0;

        // Pagination variables
        let currentPage = 1;
        const itemsPerPage = 20;

        // Initialize IndexedDB
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('IoTInventoryDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    // Create inventory store
                    if (!db.objectStoreNames.contains('inventory')) {
                        const inventoryStore = db.createObjectStore('inventory', { keyPath: 'id' });
                        inventoryStore.createIndex('sn', 'sn', { unique: true });
                        inventoryStore.createIndex('status', 'status', { unique: false });
                    }
                    
                    // Create settings store
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }

        // Load data from IndexedDB
        async function loadData() {
            try {
                // Load inventory
                const inventoryData = await getAllFromStore('inventory');
                inventory = inventoryData || [];
                
                // Load settings
                const settingsData = await getAllFromStore('settings');
                settings = {};
                settingsData.forEach(item => {
                    settings[item.key] = item.value;
                });
                
                // Fallback to localStorage if IndexedDB is empty
                if (inventory.length === 0) {
                    const localInventory = localStorage.getItem('iot-inventory');
                    if (localInventory) {
                        inventory = JSON.parse(localInventory);
                        // Save to IndexedDB for future use
                        await Promise.all(inventory.map(item => saveToStore('inventory', item))); 
                    }
                }
                
                if (Object.keys(settings).length === 0) {
                    const localSettings = localStorage.getItem('iot-settings');
                    if (localSettings) {
                        settings = JSON.parse(localSettings);
                        // Save to IndexedDB for future use
                        await Promise.all(Object.keys(settings).map(key => saveToStore('settings', { key: key, value: settings[key] }))); 
                    }
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                // Fallback to localStorage
                inventory = JSON.parse(localStorage.getItem('iot-inventory') || '[]');
                settings = JSON.parse(localStorage.getItem('iot-settings') || '{}');
            }
        }

        // Get all data from a store
        function getAllFromStore(storeName) {
            return new Promise((resolve, reject) => {
                if (!db) return resolve([]);
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Save data to IndexedDB store
        function saveToStore(storeName, data) {
            return new Promise((resolve, reject) => {
                if (!db) return resolve();
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Clear store
        function clearStore(storeName) {
            return new Promise((resolve, reject) => {
                if (!db) return resolve();
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Cloud sync functions - ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô Google Apps Script
        let isUpdatingFromSync = false;
        let syncCheckInterval;
        let cloudSyncUrl = '';
        
        // Initialize sync system
        function initSyncSystem() {
            // Check for updates every 5 seconds
            syncCheckInterval = setInterval(checkForCloudUpdates, 5000);
            
            // Load cloud sync URL from settings
            cloudSyncUrl = settings.sheetsUrl || '';
            
            // Setup listener for settings change (e.g., cloud sync toggle)
            document.getElementById('cloud-sync-toggle').addEventListener('change', saveSettings);
            document.getElementById('sheets-url').addEventListener('change', saveSettings);
            document.getElementById('api-key').addEventListener('change', saveSettings);
            document.getElementById('auto-sync').addEventListener('change', saveSettings);

            console.log('Cloud sync system initialized');
        }
        
        // Check for updates from cloud
        async function checkForCloudUpdates() {
            if (isUpdatingFromSync || !cloudSyncEnabled || !cloudSyncUrl) return;
            
            try {
                updateSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö... üîÑ');
                
                // Get data from cloud
                const response = await fetch(cloudSyncUrl + '?action=getData&timestamp=' + Date.now(), {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const cloudData = await response.json();
                    
                    if (cloudData.success && cloudData.data && cloudData.timestamp > lastSyncTime) {
                        isUpdatingFromSync = true;
                        
                        inventory = cloudData.data.inventory || [];
                        settings = { ...settings, ...cloudData.data.settings };
                        lastSyncTime = cloudData.timestamp;

                        // Save new data to IndexedDB locally
                        await clearStore('inventory');
                        await Promise.all(inventory.map(item => saveToStore('inventory', item)));
                        await clearStore('settings');
                        await Promise.all(Object.keys(settings).map(key => saveToStore('settings', { key: key, value: settings[key] })));
                        
                        // Update UI
                        updateOverview();
                        loadSettings();
                        
                        console.log('Updated from cloud:', inventory.length, 'items');
                        updateSyncStatus('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ');
                        
                        isUpdatingFromSync = false;
                    } else {
                         updateSyncStatus('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô üü¢');
                    }
                } else {
                     updateSyncStatus('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô üü¢');
                }
            } catch (error) {
                console.error('Cloud check error, reverting to local:', error);
                updateSyncStatus('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô üì±', 'text-orange-700');
                // Fallback is handled by general loadData/loadSharedData mechanism on startup
            }
        }
        
        
        // Generate unique client ID (Not strictly used for sync logic but good practice)
        function getClientId() {
            let clientId = localStorage.getItem('iot-client-id');
            if (!clientId) {
                clientId = 'client-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('iot-client-id', clientId);
            }
            return clientId;
        }
        
        // Share data to cloud and localStorage (Called after every successful CUD operation)
        async function shareUpdate() {
            if (isUpdatingFromSync) return;
            
            const timestamp = Date.now();
            const sharedData = {
                inventory: inventory,
                settings: settings,
                clientId: getClientId(),
                timestamp: timestamp
            };
            
            // Update timestamp
            lastSyncTime = timestamp;
            
            // Save to localStorage as a fallback / immediate cross-tab check
            try {
                localStorage.setItem('iot-shared-data', JSON.stringify(sharedData));
                localStorage.setItem('iot-shared-timestamp', timestamp.toString());
            } catch (error) {
                console.error('localStorage share error:', error);
            }
            
            // Save to cloud for cross-device sync
            if (cloudSyncEnabled && cloudSyncUrl) {
                try {
                    // Using no-cors here because Google Apps Script (GAS) Web App deployment defaults
                    // prevent us from inspecting the JSON response directly from a POST if not configured carefully.
                    // This is for fire-and-forget sync.
                    await fetch(cloudSyncUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        // NOTE: Removed 'Content-Type: application/json' header to ensure a "Simple Request"
                        // is made, bypassing the preflight OPTIONS check that fails with GAS on localhost.
                        body: JSON.stringify({
                            action: 'saveData',
                            data: sharedData,
                            timestamp: timestamp
                        })
                    });
                    
                    console.log('Shared update to cloud:', inventory.length, 'items');
                    updateSyncStatus('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏õ‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚òÅÔ∏è');
                } catch (error) {
                    console.error('Cloud share error:', error);
                    updateSyncStatus('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô üì±', 'text-orange-700');
                }
            }
        }
        
        // Load shared data from cloud first, then IndexedDB
        async function loadSharedData() {
            // Priority 1: Cloud
            if (cloudSyncUrl) {
                try {
                    const response = await fetch(cloudSyncUrl + '?action=getData&timestamp=' + Date.now(), {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const cloudData = await response.json();
                        
                        if (cloudData.success && cloudData.data) {
                            inventory = cloudData.data.inventory || [];
                            settings = cloudData.data.settings || {};
                            lastSyncTime = cloudData.timestamp;
                            
                            // Save new data to IndexedDB locally
                            await clearStore('inventory');
                            await Promise.all(inventory.map(item => saveToStore('inventory', item)));
                            await clearStore('settings');
                            await Promise.all(Object.keys(settings).map(key => saveToStore('settings', { key: key, value: settings[key] })));

                            updateOverview();
                            loadSettings();
                            
                            console.log('Loaded from cloud:', inventory.length, 'items');
                            updateSyncStatus('‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚òÅÔ∏è');
                        }
                    } else {
                        throw new Error('HTTP Error: ' + response.status);
                    }
                } catch (error) {
                    console.error('Cloud load error, trying local storage:', error);
                    updateSyncStatus('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô üì±', 'text-orange-700');
                    // Fall through to local load
                    await loadData();
                }
            } else {
                // Priority 2: IndexedDB / Local Storage
                await loadData();
            }
            // Update UI after loading is complete
            updateOverview();
            loadSettings();
        }

        // --- Core Inventory Logic ---

        // Helper to normalize SNs from textarea
        function normalizeSNs(snText) {
            return snText
                .split(/[\n,]/) // Split by newline or comma
                .map(sn => sn.trim())
                .filter(sn => sn.length > 0);
        }

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        // --- Tab Management ---
        function showTab(tabName) {
            ['overview', 'receive', 'issue', 'settings'].forEach(name => {
                const tab = document.getElementById(`${name}-tab`);
                const btn = document.getElementById(`tab-${name}`);
                if (name === tabName) {
                    tab.classList.remove('hidden');
                    btn.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
                    btn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
                } else {
                    tab.classList.add('hidden');
                    btn.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');
                }
            });
            if (tabName === 'overview') {
                updateOverview();
            }
            if (tabName === 'settings') {
                loadSettings();
            }
        }

        // --- UI Update & Rendering ---
        
        function updateOverview() {
            // Update summary statistics
            const totalItems = inventory.length;
            const issuedItems = inventory.filter(item => item.status === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß').length;
            const stockItems = totalItems - issuedItems;

            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('stock-items').textContent = stockItems;
            document.getElementById('issued-items').textContent = issuedItems;
            
            // Render table
            renderTable();
        }

        function renderTable() {
            const tableBody = document.getElementById('items-table');
            tableBody.innerHTML = '';
            
            // Sort inventory by date descending (latest first)
            const sortedInventory = [...inventory].sort((a, b) => b.timestamp - a.timestamp);
            
            // Calculate total pages
            const totalItems = sortedInventory.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            // Adjust current page if necessary
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0) {
                currentPage = 1;
            }

            // Slice data for the current page
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = sortedInventory.slice(startIndex, endIndex);

            paginatedItems.forEach(item => {
                const statusClass = item.status === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800';
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900">${item.sn}</td>
                    <td class="px-4 py-3">${item.product || 'N/A'}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-3 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                            ${item.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-gray-500">${new Date(item.timestamp).toLocaleString('th-TH')}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update pagination controls
            document.getElementById('page-info').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} ‡∏à‡∏≤‡∏Å ${totalPages || 1}`;
            document.getElementById('prev-page-btn').disabled = currentPage === 1;
            document.getElementById('next-page-btn').disabled = currentPage === totalPages || totalPages === 0;
        }
        
        function changePage(delta) {
            const totalPages = Math.ceil(inventory.length / itemsPerPage);
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        // --- Message System ---
        function showMessage(message, type = 'success') {
            const container = document.getElementById('message-container');
            const color = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : (type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'));
            const item = document.createElement('div');
            item.className = `p-4 mb-2 rounded-lg shadow-xl text-white fade-in ${color}`;
            item.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : (type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>')}
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            container.appendChild(item);
            setTimeout(() => {
                item.classList.remove('fade-in');
                item.style.opacity = '0';
                item.style.transform = 'translateY(-10px)';
                setTimeout(() => item.remove(), 300);
            }, 5000);
        }
        
        function updateSyncStatus(message, classes = 'text-blue-700') {
            const statusElement = document.getElementById('sync-status');
            if (statusElement) {
                statusElement.innerHTML = message;
                statusElement.className = `font-medium ${classes}`;
            }
        }
        
        // --- CRUD Operations ---

        // üì• Receive Item
        async function receiveItem(event) {
            event.preventDefault();
            const snText = document.getElementById('receive-sn').value;
            const product = document.getElementById('receive-product').value;
            const sns = normalizeSNs(snText);

            if (!product) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤!', 'error');
                return;
            }
            if (sns.length === 0) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Serial Number ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß!', 'error');
                return;
            }

            let receivedCount = 0;
            let rejectedCount = 0;
            const newInventory = [];
            const timestamp = Date.now();
            
            for (const sn of sns) {
                const existingIndex = inventory.findIndex(item => item.sn === sn);

                if (existingIndex !== -1) {
                    // Item exists, update status to stock if currently issued
                    if (inventory[existingIndex].status === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß') {
                        inventory[existingIndex].status = '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ';
                        inventory[existingIndex].product = product; // Update product name
                        inventory[existingIndex].technician = ''; // Clear technician
                        inventory[existingIndex].timestamp = timestamp;
                        await saveToStore('inventory', inventory[existingIndex]);
                        receivedCount++;
                    } else {
                        // Already in stock
                        rejectedCount++;
                        console.warn(`SN ${sn} is already in stock.`);
                    }
                } else {
                    // New item
                    const newItem = {
                        id: generateUniqueId(),
                        sn: sn,
                        product: product,
                        status: '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ',
                        timestamp: timestamp,
                        technician: ''
                    };
                    inventory.push(newItem);
                    newInventory.push(newItem);
                    await saveToStore('inventory', newItem);
                    receivedCount++;
                }
            }

            if (receivedCount > 0) {
                showMessage(`‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${receivedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
            }
            if (rejectedCount > 0) {
                showMessage(`‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ${rejectedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`, 'warning');
            }

            document.getElementById('receive-sn').value = '';
            document.getElementById('receive-product').value = '';

            await shareUpdate();
            updateOverview();
        }

        // üì§ Issue Item
        async function issueItem(event) {
            event.preventDefault();
            const snText = document.getElementById('issue-sn').value;
            const technician = document.getElementById('issue-technician').value.trim();
            const sns = normalizeSNs(snText);

            if (!technician) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å!', 'error');
                return;
            }
            if (sns.length === 0) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Serial Number ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß!', 'error');
                return;
            }

            let issuedCount = 0;
            let notFoundCount = 0;
            let alreadyIssuedCount = 0;
            const timestamp = Date.now();

            for (const sn of sns) {
                const existingIndex = inventory.findIndex(item => item.sn === sn);

                if (existingIndex !== -1) {
                    if (inventory[existingIndex].status === '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ') {
                        inventory[existingIndex].status = '‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
                        inventory[existingIndex].technician = technician;
                        inventory[existingIndex].timestamp = timestamp;
                        await saveToStore('inventory', inventory[existingIndex]);
                        issuedCount++;
                    } else {
                        alreadyIssuedCount++;
                    }
                } else {
                    notFoundCount++;
                }
            }
            
            if (issuedCount > 0) {
                showMessage(`‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${issuedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á ${technician}`, 'success');
            }
            if (alreadyIssuedCount > 0) {
                showMessage(`‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ${alreadyIssuedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß`, 'warning');
            }
            if (notFoundCount > 0) {
                showMessage(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö SN ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ: ${notFoundCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'error');
            }

            document.getElementById('issue-sn').value = '';
            document.getElementById('issue-technician').value = '';
            
            await shareUpdate();
            updateOverview();
        }

        // --- Settings and Cloud Logic ---
        
        function loadSettings() {
            document.getElementById('sheets-url').value = settings.sheetsUrl || '';
            document.getElementById('api-key').value = settings.apiKey || '';
            document.getElementById('auto-sync').checked = settings.autoSync !== false;
            document.getElementById('cloud-sync-toggle').checked = settings.cloudSyncEnabled !== false;
            cloudSyncEnabled = settings.cloudSyncEnabled !== false;
            cloudSyncUrl = settings.sheetsUrl || '';
            
            // Update settings object
            settings = {
                sheetsUrl: document.getElementById('sheets-url').value,
                apiKey: document.getElementById('api-key').value,
                autoSync: document.getElementById('auto-sync').checked,
                cloudSyncEnabled: document.getElementById('cloud-sync-toggle').checked
            };
        }

        async function saveSettings() {
            settings = {
                sheetsUrl: document.getElementById('sheets-url').value,
                apiKey: document.getElementById('api-key').value,
                autoSync: document.getElementById('auto-sync').checked,
                cloudSyncEnabled: document.getElementById('cloud-sync-toggle').checked
            };
            
            await Promise.all(Object.keys(settings).map(key => saveToStore('settings', { key: key, value: settings[key] })));
            localStorage.setItem('iot-settings', JSON.stringify(settings)); // Fallback
            
            cloudSyncUrl = settings.sheetsUrl;
            cloudSyncEnabled = settings.cloudSyncEnabled;
            
            showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }
        
        async function testConnection() {
            const url = document.getElementById('sheets-url').value;
            if (!url) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Google Apps Script URL ‡∏Å‡πà‡∏≠‡∏ô!', 'error');
                return;
            }
            
            showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...', 'info');

            try {
                // Retry logic for robustness against temporary network issues
                let response = null;
                const maxRetries = 3;
                let delay = 1000;
                
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        // FIX: Removed 'Content-Type: application/json' header to ensure a "Simple Request"
                        // is made, bypassing the preflight OPTIONS check that fails with GAS on localhost.
                        response = await fetch(url, {
                            method: 'POST',
                            mode: 'cors',
                            body: JSON.stringify({ action: 'test' })
                        });
                        if (response.ok) break; // Success, break retry loop
                    } catch (e) {
                        // Network error, pause before retry
                        if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                        } else {
                             throw e; // Last retry failed, throw original error
                        }
                    }
                }
                
                if (response && response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showMessage('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ', 'success');
                        return;
                    } else {
                        // The Apps Script deployed, but the code failed internally
                        showMessage('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (Apps Script ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô): ' + (result.error || 'Unknown error'), 'error');
                        return;
                    }
                } else {
                    // The request reached the server but returned a non-200 status
                     throw new Error('HTTP Error: ' + response?.status);
                }

            } catch (error) {
                // The network request failed completely (e.g. CORS, bad URL, deployment error)
                showMessage('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£ Deploy', 'error');
                console.error('Connection Test Error:', error);
            }
        }
        
        async function exportToGoogleSheets() {
            if (!cloudSyncUrl) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script URL ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                showTab('settings');
                return;
            }
            
            const inventoryToExport = inventory.map(item => ({
                SN: item.sn,
                Product: item.product,
                Status: item.status,
                Technician: item.technician || '-',
                Date: new Date(item.timestamp).toLocaleString('th-TH')
            }));

            if (inventoryToExport.length === 0) {
                 showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'info');
                 return;
            }
            
            showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets...', 'info');

            try {
                // FIX: Removed 'Content-Type: application/json' header to ensure a "Simple Request"
                // is made, bypassing the preflight OPTIONS check that fails with GAS on localhost.
                const response = await fetch(cloudSyncUrl, {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify({ 
                        action: 'updateInventory', 
                        data: inventoryToExport,
                        apiKey: settings.apiKey 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${result.rows} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                } else {
                    showMessage('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                console.error('Export Error:', error);
            }
        }

        // --- Password Confirmation and Deletion Logic ---

        // 1. ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏•‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const DELETE_PASSWORD = "John19195";

        function showDeleteConfirmModal() {
            document.getElementById('delete-modal').classList.remove('hidden');
            document.getElementById('delete-password').value = ''; // Clear input on open
            document.getElementById('delete-password').focus();
        }

        function hideDeleteConfirmModal() {
            document.getElementById('delete-modal').classList.add('hidden');
        }

        /**
         * üö® ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô üö®
         */
        async function confirmDeleteAllData() {
            const enteredPassword = document.getElementById('delete-password').value;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            if (enteredPassword === DELETE_PASSWORD) {
                // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á -> ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                await deleteAllData();
                hideDeleteConfirmModal();
                showMessage('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                updateOverview();
            } else {
                // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á -> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                showMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                document.getElementById('delete-password').value = '';
                document.getElementById('delete-password').focus();
            }
        }

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å IndexedDB, LocalStorage ‡πÅ‡∏•‡∏∞ Cloud
         */
        async function deleteAllData() {
            // ‡∏•‡πâ‡∏≤‡∏á IndexedDB
            await clearStore('inventory');
            await clearStore('settings');

            // ‡∏•‡πâ‡∏≤‡∏á LocalStorage (‡∏ï‡∏±‡∏ß‡∏™‡∏≥‡∏£‡∏≠‡∏á)
            localStorage.removeItem('iot-inventory');
            localStorage.removeItem('iot-settings');
            localStorage.removeItem('iot-shared-data');
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
            inventory = [];
            settings = {};
            
            // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Cloud (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà)
            await shareUpdate(); // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÑ‡∏õ Cloud ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß

            console.log('All data deleted successfully.');
        }

        // --- Initialization ---

        window.onload = async () => {
            await initDB();
            await loadSharedData();
            loadSettings();
            initSyncSystem();
            showTab('overview'); // Start on the overview tab
        };
        
        // BroadcastChannel for real-time update between tabs/windows
        const channel = new BroadcastChannel('iot-inventory-channel');
        channel.onmessage = async (event) => {
            if (event.data.action === 'dataUpdate' && !isUpdatingFromSync) {
                console.log('Broadcast received, checking for updates...');
                // Force a full update from cloud/local to ensure consistency
                await loadSharedData(); 
            }
        };

        // Override the shareUpdate to also broadcast
        const originalShareUpdate = shareUpdate;
        shareUpdate = async function() {
            await originalShareUpdate();
            // Send broadcast to other local tabs/windows
            channel.postMessage({ action: 'dataUpdate', timestamp: Date.now() });
        };
        
        // Call shareUpdate when settings change to keep other tabs/devices updated
        const originalSaveSettings = saveSettings;
        saveSettings = async function() {
            await originalSaveSettings();
            await shareUpdate();
        };

    </script>
</body>
</html>
